package cdg.swi.game.menu;

import java.nio.ByteBuffer;
import java.util.*;

import cdg.swi.game.util.Utility;

import org.lwjgl.input.Mouse;
import org.lwjgl.opengl.GL11;
import org.lwjgl.opengl.GL20;

import cdg.swi.game.util.StaticManager;
import cdg.swi.game.util.interfaces.IClickListener;
import cdg.swi.game.util.interfaces.IGameControl;
import cdg.swi.game.util.interfaces.IMenuObject;
import cdg.swi.game.util.interfaces.ISelectListener;

public abstract class MenuFrame {

	private List<Component> components;
	private int lastSelectedId;
	private IGameControl control;
	
	public MenuFrame(IGameControl control)
	{
		this.control = control;
		this.components = new ArrayList<Component>();
	}
	
	protected void add(Component comp)
	{
		int newID;
		if(this.components.size() != 0)
			newID = this.components.get(this.components.size()-1).getId()+1;
		else
			newID = 1;
		comp.setId(newID);
		this.components.add(comp);
	}
	
	protected void remove(int index)
	{
		this.components.remove(0);
	}
	
	protected void remove(Component comp)
	{
		this.components.remove(comp);
	}
	
	protected void setComponent(int index, Component comp)
	{
		int id = this.components.get(index).getId();
		comp.setId(id);
		this.components.set(index, comp);
	}
	
	protected Component getComponentById(int id)
	{
		for(int i = 0; i < this.components.size(); i++)
		{
			if(this.components.get(i).getId() == id)
				return this.components.get(i);
		}
		return null;
	}
	
	protected Component getComponent(int index)
	{
		return this.components.get(index);
	}
	
	protected List<Component> getComponents()
	{                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
		return this.components;
	}
	
	public void draw()
	{
		this.doSelection(true,true);
		for(int i = 0; i < this.components.size(); i++)
		{
			this.components.get(i).drawUI();
		}
	}
	
	public void doSelection()
	{
		doSelection(false,false);
	}
	
	public void doSelection(boolean clearAfter)
	{
		doSelection(false,clearAfter);
	}
	
	public void doSelection(boolean clearBefore, boolean clearAfter)
	{
		if(clearBefore)
		{
			GL11.glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
			GL11.glClear(GL11.GL_COLOR_BUFFER_BIT | GL11.GL_DEPTH_BUFFER_BIT);
		}
		
		GL20.glUseProgram(StaticManager.SELECTION_SHADER_PROGRAM_ID);
		for(int i = 0; i < components.size(); i++)
		{
			components.get(i).drawSelection();
		}
		GL20.glUseProgram(0);
		
		ByteBuffer pixel = ByteBuffer.allocateDirect(16);
		GL11.glReadPixels(Mouse.getX(), Mouse.getY(), 1, 1, GL11.GL_RGBA, GL11.GL_UNSIGNED_BYTE, pixel);
		int gotId = cdg.swi.game.util.Utility.glColorToId(new byte[]{pixel.get(0),pixel.get(1),pixel.get(2),pixel.get(3)}, false);
		
		//System.out.println("Got id: "+gotId); // TODO: remove debug;
		
		if(gotId != this.lastSelectedId)
		{
			Component c = this.getComponentById(lastSelectedId);
			if(c != null)
			{
				List<ISelectListener> l = c.getSelectListener();
				for(int i = 0; i < l.size(); i++)
				{
					l.get(i).unselected();
				}
			}
		}
		
		if(Mouse.isButtonDown(0))
		{
			Component c = this.getComponentById(gotId);
			if(c != null)
			{
				List<IClickListener> l = this.getComponentById(gotId).getClickListener();
				for(int i = 0; i < l.size(); i++)
				{
					l.get(i).clicked(Mouse.getX(),Mouse.getY(),0);
				}
			}
		}
		else
		{
			Component c = this.getComponentById(gotId);
			if(c != null)
			{
				List<ISelectListener> l = c.getSelectListener();
				for(int i = 0; i < l.size(); i++)
				{
					l.get(i).selected(Mouse.getX(),Mouse.getY());
				}
				this.lastSelectedId = gotId;
			}
		}
		
		if(clearAfter)
		{
			GL11.glClearColor(StaticManager.CLEAR_COLOR[0], 
							  StaticManager.CLEAR_COLOR[1], 
							  StaticManager.CLEAR_COLOR[2], 
							  StaticManager.CLEAR_COLOR[3]);
			GL11.glClear(GL11.GL_COLOR_BUFFER_BIT | GL11.GL_DEPTH_BUFFER_BIT);
		}
	}

	/**
	 * @return the control
	 */
	public IGameControl getControl() {
		return control;
	}
}
